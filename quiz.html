<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Quiz</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-3">Interactive Quiz</h1>
    <div class="mb-3">
      <label for="userName" class="form-label">Your name</label>
      <input id="userName" class="form-control" placeholder="Enter name (e.g., Alice)">
    </div>
    <div class="mb-3">
      <label for="moduleSelect" class="form-label">Choose module</label>
      <select id="moduleSelect" class="form-select"></select>
    </div>
    <div id="questionsArea"></div>
    <div class="mt-3">
      <button id="submitBtn" class="btn btn-primary">Submit Answers</button>
      <button id="resetBtn" class="btn btn-secondary ms-2">Reset</button>
    </div>
    <div id="resultArea" class="mt-4"></div>
  </div>

  <script src="/static/ajax.js"></script>
  <script>
    async function init(){
      const quizzes = await getJSON('/api/quizzes');
      const sel = document.getElementById('moduleSelect');
      quizzes.modules.forEach(mod=>{
        const opt = document.createElement('option');
        opt.value = mod.module_id;
        opt.text = mod.title;
        sel.add(opt);
      });
      sel.addEventListener('change', ()=> renderQuestions(quizzes, sel.value));
      if(quizzes.modules.length) renderQuestions(quizzes, quizzes.modules[0].module_id);
      document.getElementById('submitBtn').addEventListener('click', submitAnswers);
      document.getElementById('resetBtn').addEventListener('click', ()=>{ renderQuestions(quizzes, sel.value); document.getElementById('resultArea').innerHTML=''; });
    }

    function renderQuestions(quizzes, module_id){
      const container = document.getElementById('questionsArea');
      container.innerHTML='';
      const mod = quizzes.modules.find(m=>m.module_id===module_id);
      if(!mod) return;
      mod.questions.forEach((q, idx)=>{
        const card = document.createElement('div');
        card.className = 'card mb-2';
        card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">Q${idx+1}. ${q.text}</h5>
            <div id="opts-${q.id}"></div>
          </div>`;
        container.appendChild(card);
        const optsDiv = card.querySelector('#opts-' + q.id);
        q.options.forEach((opt, i)=>{
          const id = 'opt-'+q.id+'-'+i;
          const html = `
            <div class="form-check">
              <input class="form-check-input" type="radio" name="${q.id}" id="${id}" value="${i}">
              <label class="form-check-label" for="${id}">${opt}</label>
            </div>`;
          optsDiv.insertAdjacentHTML('beforeend', html);
        });
      });
    }

    async function submitAnswers(){
      const name = document.getElementById('userName').value.trim() || 'Guest';
      const module_id = document.getElementById('moduleSelect').value;
      const quizModule = (await getJSON('/api/quizzes')).modules.find(m=>m.module_id===module_id);
      const payload = { user_name: name, module_id: module_id, answers: {} };
      quizModule.questions.forEach(q=>{
        const radios = document.getElementsByName(q.id);
        let chosen = null;
        for(const r of radios){ if(r.checked){ chosen = parseInt(r.value); break; } }
        if(chosen !== null) payload.answers[q.id] = chosen;
      });
      const res = await postJSON('/api/submit', payload);
      document.getElementById('resultArea').innerHTML = `
        <div class="alert alert-info">Score: <strong>${res.score}</strong> / ${quizModule.questions.length}</div>
        <div><a href="/dashboard.html" class="btn btn-outline-primary">View Dashboard</a>
        <a href="/leaderboard.html" class="btn btn-outline-secondary ms-2">Leaderboard</a></div>
      `;
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
